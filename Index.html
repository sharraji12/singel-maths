<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KVS workspace - Advanced MCQ Extractor and Solver (Firebase Full Edition)</title>
    <style>
        :root {
            --bg-color: #f4f4f4;
            --text-color: #333;
            --container-bg: #fff;
            --button-bg: #3498db;
            --button-hover: #2980b9;
            --code-bg: #f8f8f8;
            --border-color: #ddd;
            --table-header-bg: #f2f2f2;
            --sidebar-bg: #2c3e50;
            --sidebar-text: #ecf0f1;
        }

        [data-theme="dark"] {
            --bg-color: #2c3e50;
            --text-color: #ecf0f1;
            --container-bg: #34495e;
            --button-bg: #2980b9;
            --button-hover: #3498db;
            --code-bg: #2c3e50;
            --border-color: #7f8c8d;
            --table-header-bg: #2c3e50;
            --sidebar-bg: #1a252f;
            --sidebar-text: #bdc3c7;
        }

        [data-theme="blue"] {
            --bg-color: #e6f3ff;
            --text-color: #003366;
            --container-bg: #ffffff;
            --button-bg: #007bff;
            --button-hover: #0056b3;
            --code-bg: #f0f8ff;
            --border-color: #b3d9ff;
            --table-header-bg: #cce5ff;
            --sidebar-bg: #003366;
            --sidebar-text: #ffffff;
        }

        [data-theme="green"] {
            --bg-color: #e8f5e9;
            --text-color: #1b5e20;
            --container-bg: #ffffff;
            --button-bg: #4caf50;
            --button-hover: #45a049;
            --code-bg: #f1f8e9;
            --border-color: #c8e6c9;
            --table-header-bg: #a5d6a7;
            --sidebar-bg: #1b5e20;
            --sidebar-text: #ffffff;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            transition: background-color 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--container-bg);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 100px;
            transition: margin-left 0.3s ease;
        }

        h1 {
            color: var(--text-color);
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 30px;
        }

        #imageGrid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }

        .image-container {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        #imageGrid img {
            width: 100%;
            height: auto;
            display: block;
        }

        .image-controls {
            position: absolute;
            top: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
        }

        .image-control-btn {
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .image-control-btn:hover {
            background-color: rgba(0, 0, 0, 0.7);
        }

        button, .file-input-label {
            background-color: var(--button-bg);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            transition: background-color 0.3s, transform 0.1s;
            font-size: 16px;
            font-weight: 500;
        }

        button:hover, .file-input-label:hover {
            background-color: var(--button-hover);
            transform: translateY(-2px);
        }

        button:active, .file-input-label:active {
            transform: translateY(0);
        }

        .code-block {
            background-color: var(--code-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-top: 30px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', Courier, monospace;
            position: relative;
            font-size: 14px;
            line-height: 1.6;
        }

        .copy-button, .delete-button, .edit-button, .verify-button {
            position: absolute;
            top: 10px;
            background-color: rgba(39, 174, 96, 0.8);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .copy-button { right: 10px; }
        .delete-button { right: 70px; background-color: rgba(231, 76, 60, 0.8); }
        .edit-button { right: 140px; background-color: rgba(243, 156, 18, 0.8); }
        .verify-button { right: 210px; background-color: rgba(52, 152, 219, 0.8); }

        .copy-button:hover { background-color: rgba(46, 204, 113, 0.9); }
        .delete-button:hover { background-color: rgba(192, 57, 43, 0.9); }
        .edit-button:hover { background-color: rgba(211, 84, 0, 0.9); }
        .verify-button:hover { background-color: rgba(41, 128, 185, 0.9); }

        #pdfInput, #imageInput {
            display: none;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 15px;
        }

        th, td {
            border: 1px solid var(--border-color);
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: var(--table-header-bg);
            font-weight: bold;
        }

        #promptBox {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--container-bg);
            padding: 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #promptInput {
            width: 60%;
            padding: 12px;
            margin-right: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 16px;
        }

        #promptImageInput {
            display: none;
        }

        .prompt-image-label {
            background-color: #27ae60;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-right: 10px;
            transition: background-color 0.3s;
        }

        .prompt-image-label:hover {
            background-color: #2ecc71;
        }

        #promptImagePreview {
            max-width: 50px;
            max-height: 50px;
            margin-right: 10px;
            border-radius: 4px;
        }

        #themeToggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--button-bg);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
            z-index: 1001;
        }

        #themeToggle:hover {
            background-color: var(--button-hover);
        }

        .editable {
            min-height: 100px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            outline: none;
        }

        .editable:focus {
            border-color: var(--button-bg);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.3);
        }

        #promptPreview {
            width: 100%;
            min-height: 100px;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--code-bg);
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        #promptImages {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        #promptImages img {
            max-width: 100px;
            max-height: 100px;
            object-fit: cover;
            border-radius: 4px;
        }

        #modelSelect {
            margin-bottom: 10px;
        }

        #progressBar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            margin-top: 20px;
            overflow: hidden;
        }

        #progressBarFill {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.5s ease-in-out;
        }

        #progressText {
            text-align: center;
            margin-top: 5px;
        }

        .error-message {
            color: #e74c3c;
            margin-top: 10px;
            font-weight: bold;
        }

        #timerDisplay {
            text-align: center;
            font-size: 18px;
            margin-top: 10px;
            font-weight: bold;
        }

        .mcq-table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
        }

        .mcq-table th, .mcq-table td {
            border: 1px solid var(--border-color);
            padding: 8px;
            text-align: left;
        }

        .mcq-table th {
            background-color: var(--table-header-bg);
            font-weight: bold;
        }

        .file-input-label {
            position: relative;
            overflow: hidden;
        }
        .file-input-label input[type="file"] {
            position: absolute;
            top: 0;
            right: 0;
            min-width: 100%;
            min-height: 100%;
            font-size: 100px;
            text-align: right;
            filter: alpha(opacity=0);
            opacity: 0;
            outline: none;
            background: white;
            cursor: inherit;
            display: block;
        }

        #cropperModal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.9);
        }

        #cropperContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        #cropperImage {
            max-width: 90%;
            max-height: 80%;
        }

        #cropperControls {
            margin-top: 20px;
        }

        .cropper-btn {
            background-color: var(--button-bg);
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 0 10px;
            border-radius: 5px;
            cursor: pointer;
        }

        .cropper-btn:hover {
            background-color: var(--button-hover);
        }

        #authContainer {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
        }

        #loginForm, #signupForm {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 300px;
        }

        #loginForm input, #signupForm input {
            margin-bottom: 10px;
            padding: 10px;
            width: 100%;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        #userInfo {
            text-align: center;
            margin-bottom: 20px;
        }

        #savedMCQs {
            margin-top: 20px;
        }

        .mcq-item {
            background-color: var(--container-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .mcq-item:hover {
            background-color: var(--button-bg);
            color: white;
        }

        #sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100%;
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            transition: left 0.3s ease;
            overflow-y: auto;
            z-index: 1000;
        }

        #sidebar.open {
            left: 0;
        }

        #sidebarToggle {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background-color: var(--button-bg);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s;
        }

        #sidebarToggle:hover {
            background-color: var(--button-hover);
        }

        .chat-item {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }

        .chat-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        #newChatBtn {
            width: 100%;
            padding: 10px;
            background-color: var(--button-bg);
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #newChatBtn:hover {
            background-color: var(--button-hover);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            #promptBox {
                flex-direction: column;
            }

            #promptInput {
                width: 100%;
                margin-bottom: 10px;
            }

            .image-controls {
                flex-direction: column;
            }

            .image-control-btn {
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <button id="themeToggle">ðŸŒ“</button>
    <button id="sidebarToggle">â˜°</button>
    <div id="sidebar">
        <button id="newChatBtn">New Chat</button>
        <div id="chatList"></div>
    </div>
    <div class="container">
        <h1>KVS workspace - Advanced MCQ Extractor and Solver (Firebase Full Edition)</h1>
        
        <div id="authContainer">
            <div id="loginForm">
                <h2>Login</h2>
                <input type="email" id="loginEmail" placeholder="Email">
                <input type="password" id="loginPassword" placeholder="Password">
                <button onclick="login()">Login</button>
                <button onclick="loginWithGoogle()">Login with Google</button>
            </div>
            <div id="signupForm">
                <h2>Sign Up</h2>
                <input type="email" id="signupEmail" placeholder="Email">
                <input type="password" id="signupPassword" placeholder="Password">
                <input type="tel" id="phoneNumber" placeholder="Phone Number (for OTP)">
                <button onclick="signup()">Sign Up</button>
            </div>
            <div id="otpForm" style="display: none;">
                <h2>Enter OTP</h2>
                <input type="text" id="otpInput" placeholder="Enter OTP">
                <button onclick="verifyOTP()">Verify OTP</button>
            </div>
        </div>

        <div id="userInfo" style="display: none;">
            <p>Logged in as: <span id="userEmail"></span></p>
            <button onclick="logout()">Logout</button>
        </div>

        <div id="appContent" style="display: none;">
            <input type="text" id="apiKey" placeholder="Enter your Gemini API Key" style="width: 100%; padding: 12px; margin-bottom: 20px; border-radius: 8px; border: 1px solid var(--border-color);">
            <select id="modelSelect" style="width: 100%; padding: 12px; margin-bottom: 20px; border-radius: 8px; border: 1px solid var(--border-color);">
                <option value="gemini-1.5-pro-latest">Gemini 1.5 Pro</option>
                <option value="gemini-1.0-pro-latest">Gemini 1.0 Pro</option>
            </select>
            <div>
                <label for="pdfInput" class="file-input-label">
                    Upload PDF
                    <input type="file" id="pdfInput" accept=".pdf">
                </label>
                <label for="imageInput" class="file-input-label">
                    Add Images
                    <input type="file" id="imageInput" accept="image/*" multiple>
                </label>
                <button onclick="processMCQs(false)">Extract MCQs Only</button>
                <button onclick="processMCQs(true)">Extract and Solve MCQs</button>
                <button onclick="orderMCQs()">Order MCQs Numerically</button>
                <button onclick="copyAllResults()">Copy All Results</button>
                <button onclick="recheckSolutions()">Recheck Solutions</button>
                <button onclick="saveToFirebase()">Save Results to Firebase</button>
            </div>
            <div id="imageGrid"></div>
            <div id="progressBar">
                <div id="progressBarFill"></div>
            </div>
            <div id="progressText"></div>
            <div id="timerDisplay"></div>
            <div id="resultsContainer"></div>
            <div id="savedMCQs"></div>
        </div>
    </div>
    <div id="promptBox">
        <input type="text" id="promptInput" placeholder="Enter your prompt for modifying MCQs...">
        <label for="promptImageInput" class="prompt-image-label">Add Images</label>
        <input type="file" id="promptImageInput" accept="image/*" multiple>
        <div id="promptImages"></div>
        <button onclick="editPrompt()">Edit Prompt</button>
        <button onclick="processPrompt()">Process</button>
        <div id="promptPreview" contenteditable="true" style="display: none;"></div>
    </div>
    <audio id="alarmSound" src="https://www.soundjay.com/buttons/button-3.mp3"></audio>

    <div id="cropperModal">
        <div id="cropperContainer">
            <img id="cropperImage" src="">
            <div id="cropperControls">
                <button class="cropper-btn" onclick="applyCrop()">Apply Crop</button>
                <button class="cropper-btn" onclick="cancelCrop()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.min.js"></script>

    <!-- Cropper.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBSbpgNHrllE3LqE7AqvvJSFxOb3uHBWRs",
            authDomain: "corded-academy-404101.firebaseapp.com",
            projectId: "corded-academy-404101",
            storageBucket: "corded-academy-404101.appspot.com",
            messagingSenderId: "639823673602",
            appId: "1:639823673602:web:f97ee37fbd38ca0bca6a1b",
            measurementId: "G-8PBCR51KW5"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let images = [];
        let allResults = [];
        let promptImages = [];
        let processingQueue = [];
        let isProcessing = false;
        const RATE_LIMIT_DELAY = 1000;
        const IMAGE_PROCESSING_DELAY = 500;
        let startTime;
        let timerInterval;
        let cropper;
        let currentChatId = null;

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.worker.min.js';

        // Authentication functions
        function signup() {
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const phoneNumber = document.getElementById('phoneNumber').value;

            if (!phoneNumber.startsWith('+91')) {
                alert('OTP verification is only available for Indian phone numbers (+91).');
                return;
            }

            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    console.log('User signed up');
                    sendOTP(phoneNumber);
                })
                .catch((error) => {
                    console.error('Error signing up:', error);
                    alert('Sign up failed: ' + error.message);
                });
        }

        function sendOTP(phoneNumber) {
            // In a real implementation, you would integrate with a service to send OTP
            // For this example, we'll simulate it
            alert('OTP sent to ' + phoneNumber);
            document.getElementById('otpForm').style.display = 'block';
        }

        function verifyOTP() {
            const otp = document.getElementById('otpInput').value;
            // In a real implementation, you would verify the OTP with your service
            // For this example, we'll simulate it
            if (otp === '123456') { // Example OTP
                showUserInfo(auth.currentUser);
            } else {
                alert('Invalid OTP');
            }
        }

        function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    console.log('User logged in');
                    showUserInfo(userCredential.user);
                })
                .catch((error) => {
                    console.error('Error logging in:', error);
                    alert('Login failed: ' + error.message);
                });
        }

        function loginWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    console.log('User logged in with Google');
                    showUserInfo(result.user);
                }).catch((error) => {
                    console.error('Error logging in with Google:', error);
                    alert('Google login failed: ' + error.message);
                });
        }

        function logout() {
            auth.signOut().then(() => {
                console.log('User signed out');
                showAuthForms();
            }).catch((error) => {
                console.error('Error signing out:', error);
            });
        }

        function showUserInfo(user) {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('userInfo').style.display = 'block';
            document.getElementById('appContent').style.display = 'block';
            document.getElementById('userEmail').textContent = user.email;
            loadSavedMCQs();
            loadChatHistory();
        }

        function showAuthForms() {
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('userInfo').style.display = 'none';
            document.getElementById('appContent').style.display = 'none';
        }

        // Check auth state on page load
        auth.onAuthStateChanged((user) => {
            if (user) {
                showUserInfo(user);
            } else {
                showAuthForms();
            }
        });

        async function convertPDFToImages(file) {
            const pdf = await pdfjsLib.getDocument(URL.createObjectURL(file)).promise;
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const imageGrid = document.getElementById('imageGrid');

            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                const page = await pdf.getPage(pageNum);
                const viewport = page.getViewport({ scale: 1.5 });
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                await page.render({ canvasContext: ctx, viewport }).promise;

                const imageContainer = document.createElement('div');
                imageContainer.className = 'image-container';

                const img = new Image();
                img.src = canvas.toDataURL();
                img.onload = function() {
                    const imageFile = dataURLtoFile(img.src, `page_${pageNum}.png`);
                    
                    const removeButton = document.createElement('button');
                    removeButton.className = 'image-control-btn';
                    removeButton.textContent = 'Ã—';
                    removeButton.onclick = function() {
                        removeImage(imageContainer, imageFile);
                    };

                    const cropButton = document.createElement('button');
                    cropButton.className = 'image-control-btn';
                    cropButton.textContent = 'Crop';
                    cropButton.onclick = function() {
                        openCropper(img.src, imageFile, imageContainer);
                    };

                    const copyButton = document.createElement('button');
                    copyButton.className = 'image-control-btn';
                    copyButton.textContent = 'Copy';
                    copyButton.onclick = function() {
                        copyImageToClipboard(img);
                    };

                    const downloadButton = document.createElement('button');
                    downloadButton.className = 'image-control-btn';
                    downloadButton.textContent = 'Download';
                    downloadButton.onclick = function() {
                        downloadImage(img.src, `page_${pageNum}.png`);
                    };

                    const controlsDiv = document.createElement('div');
                    controlsDiv.className = 'image-controls';
                    controlsDiv.appendChild(removeButton);
                    controlsDiv.appendChild(cropButton);
                    controlsDiv.appendChild(copyButton);
                    controlsDiv.appendChild(downloadButton);

                    imageContainer.appendChild(img);
                    imageContainer.appendChild(controlsDiv);
                    imageGrid.appendChild(imageContainer);
                    images.push(imageFile);
                }
            }
        }

        function dataURLtoFile(dataurl, filename) {
            let arr = dataurl.split(','),
                mime = arr[0].match(/:(.*?);/)[1],
                bstr = atob(arr[1]), 
                n = bstr.length, 
                u8arr = new Uint8Array(n);
            while(n--){
                u8arr[n] = bstr.charCodeAt(n);
            }
            return new File([u8arr], filename, {type:mime});
        }

        function addImages(files) {
            const imageGrid = document.getElementById('imageGrid');
            
            for (let file of files) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageContainer = document.createElement('div');
                    imageContainer.className = 'image-container';
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    
                    const removeButton = document.createElement('button');
                    removeButton.className = 'image-control-btn';
                    removeButton.textContent = 'Ã—';
                    removeButton.onclick = function() {
                        removeImage(imageContainer, file);
                    };

                    const cropButton = document.createElement('button');
                    cropButton.className = 'image-control-btn';
                    cropButton.textContent = 'Crop';
                    cropButton.onclick = function() {
                        openCropper(img.src, file, imageContainer);
                    };

                    const copyButton = document.createElement('button');
                    copyButton.className = 'image-control-btn';
                    copyButton.textContent = 'Copy';
                    copyButton.onclick = function() {
                        copyImageToClipboard(img);
                    };

                    const downloadButton = document.createElement('button');
                    downloadButton.className = 'image-control-btn';
                    downloadButton.textContent = 'Download';
                    downloadButton.onclick = function() {
                        downloadImage(img.src, file.name);
                    };

                    const controlsDiv = document.createElement('div');
                    controlsDiv.className = 'image-controls';
                    controlsDiv.appendChild(removeButton);
                    controlsDiv.appendChild(cropButton);
                    controlsDiv.appendChild(copyButton);
                    controlsDiv.appendChild(downloadButton);

                    imageContainer.appendChild(img);
                    imageContainer.appendChild(controlsDiv);
                    imageGrid.appendChild(imageContainer);
                    images.push(file);
                }
                reader.readAsDataURL(file);
            }
        }

        function removeImage(container, file) {
            container.remove();
            images = images.filter(img => img !== file);
        }

        function openCropper(imageSrc, file, container) {
            const cropperModal = document.getElementById('cropperModal');
            const cropperImage = document.getElementById('cropperImage');
            cropperImage.src = imageSrc;
            cropperModal.style.display = 'block';

            if (cropper) {
                cropper.destroy();
            }

            cropper = new Cropper(cropperImage, {
                aspectRatio: NaN,
                viewMode: 1,
            });

            cropperModal.dataset.file = JSON.stringify(file);
            cropperModal.dataset.container = container.id;
        }

        function applyCrop() {
            const cropperModal = document.getElementById('cropperModal');
            const file = JSON.parse(cropperModal.dataset.file);
            const container = document.getElementById(cropperModal.dataset.container);

            cropper.getCroppedCanvas().toBlob((blob) => {
                const newFile = new File([blob], file.name, { type: file.type });
                const img = container.querySelector('img');
                img.src = URL.createObjectURL(blob);
                
                // Update the file in the images array
                const index = images.findIndex(i => i.name === file.name && i.size === file.size);
                if (index !== -1) {
                    images[index] = newFile;
                }

                cropper.destroy();
                cropperModal.style.display = 'none';
            });
        }

        function cancelCrop() {
            const cropperModal = document.getElementById('cropperModal');
            cropper.destroy();
            cropperModal.style.display = 'none';
        }

        function copyImageToClipboard(img) {
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            canvas.getContext('2d').drawImage(img, 0, 0, img.width, img.height);
            canvas.toBlob(function(blob) {
                navigator.clipboard.write([
                    new ClipboardItem({ 'image/png': blob })
                ]).then(function() {
                    alert('Image copied to clipboard!');
                }, function(err) {
                    console.error('Could not copy image: ', err);
                });
            });
        }

        function downloadImage(imageSrc, fileName) {
            const link = document.createElement('a');
            link.href = imageSrc;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function processMCQs(withSolution) {
            const apiKey = document.getElementById('apiKey').value;
            const modelName = document.getElementById('modelSelect').value;
            const resultsContainer = document.getElementById('resultsContainer');

            if (!apiKey) {
                alert('Please enter API key.');
                return;
            }

            if (images.length === 0) {
                alert('Please add at least one image.');
                return;
            }

            resultsContainer.innerHTML = "<div class='code-block'>Processing MCQs from images...</div>";
            allResults = [];

            processingQueue = [...images];
            isProcessing = true;
            startTimer();
            updateProgressBar(0, images.length);

            await processNextImage(apiKey, modelName, withSolution);
        }

        async function processNextImage(apiKey, modelName, withSolution) {
            if (processingQueue.length === 0) {
                isProcessing = false;
                updateProgressBar(images.length, images.length);
                displayResults();
                stopTimer();
                playAlarmSound();
                saveToChat(allResults.join('\n\n'));
                return;
            }

            const image = processingQueue.shift();

            try {
                const imageData = await getBase64(image);
                const processedMCQ = await callGeminiAPI(apiKey, modelName, imageData, image.type, withSolution);
                allResults.push(processedMCQ);
                updateProgressBar(images.length - processingQueue.length, images.length);
            } catch (error) {
                console.error(`Error processing image:`, error);
                if (error.message.includes('Rate limit exceeded')) {
                    processingQueue.unshift(image);
                    await new Promise(resolve => setTimeout(resolve, RATE_LIMIT_DELAY));
                } else {
                    allResults.push(`Error processing image: ${error.message}`);
                }
            }

            await new Promise(resolve => setTimeout(resolve, IMAGE_PROCESSING_DELAY));
            await processNextImage(apiKey, modelName, withSolution);
        }

        function getBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = error => reject(error);
            });
        }

        async function callGeminiAPI(apiKey, modelName, imageData, mimeType, withSolution) {
            const prompt = `Analyze this image containing multiple-choice questions (MCQs). Extract the questions, options, and ${withSolution ? 'provide solutions' : 'do not provide solutions'}. Follow these rules:

            1. Format each MCQ ${withSolution ? 'and its solution ' : ''}as a separate block.
            2. Left-align all content within each block.
            3. Use numbers (1, 2, 3, 4) instead of letters for options.
            4. Preserve the original question numbers from the image.
            5. ${withSolution ? 'Provide the solution directly after the options within the same block.' : 'Do not provide solutions.'}
            6. Indicate the correct answer with a green checkmark (âœ…) next to the correct option.
            7. If there's a table in the question, format it using HTML table tags. Use the class "mcq-table" for the table element.
            8. Use this format for your output:

            [Original Question number]. [Question text]
            [HTML table, if present]
            1. [Option 1]
            2. [Option 2]
            3. [Option 3]
            4. [Option 4] âœ… (if this is the correct answer)
            ${withSolution ? 'Solution: [Detailed explanation of the solution with complete calculations, presented line by line for readability]' : ''}

            9. Do not use LaTeX formatting. Present all content in plain text.
            10. Use '^' for exponents instead of HTML superscript tags. For example, write 'x^2' instead of 'x<sup>2</sup>'.
            11. If you detect a diagram or complex image in the question, add the fire emoji (ðŸ”¥) at the beginning of the question text.
            ${withSolution ? '12. Prioritize accuracy in all calculations and logic.' : ''}
            13. Separate each MCQ block with two blank lines.
            14. Do not include phrases like "Therefore, the correct answer is...".

            Your primary goal is to provide accurate, well-formatted MCQs${withSolution ? ' and solutions' : ''} based on the image content provided.`;

            const maxRetries = 5;
            const baseDelay = 1000; // 1 second

            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { text: prompt },
                                    { inline_data: { mime_type: mimeType, data: imageData } }
                                ]
                            }],
                            generationConfig: {
                                temperature: 0.1,
                                topK: 40,
                                topP: 0.95,
                                maxOutputTokens: 8192,
                                stopSequences: []
                            }
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        if (response.status === 429) {
                            const delay = baseDelay * Math.pow(2, attempt);
                            console.log(`Rate limit exceeded. Retrying in ${delay}ms...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                        throw new Error(`API error: ${response.status} - ${JSON.stringify(errorData)}`);
                    }

                    const data = await response.json();
                    return data.candidates[0].content.parts[0].text.trim();
                } catch (error) {
                    if (attempt === maxRetries - 1) {
                        throw error;
                    }
                }
            }
        }

        function displayResults() {
            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.innerHTML = '';
            allResults.forEach((result, index) => {
                const codeBlock = document.createElement('div');
                codeBlock.className = 'code-block';
                codeBlock.innerHTML = `<div class="editable" contenteditable="true">${result}</div>`;
                
                const copyButton = document.createElement('button');
                copyButton.className = 'copy-button';
                copyButton.textContent = 'Copy';
                copyButton.onclick = () => copyToClipboard(result, copyButton);
                
                const deleteButton = document.createElement('button');
                deleteButton.className = 'delete-button';
                deleteButton.textContent = 'Delete';
                deleteButton.onclick = () => deleteResult(index);
                
                const editButton = document.createElement('button');
                editButton.className = 'edit-button';
                editButton.textContent = 'Save';
                editButton.onclick = () => saveEdit(index, codeBlock.querySelector('.editable'));
                
                const verifyButton = document.createElement('button');
                verifyButton.className = 'verify-button';
                verifyButton.textContent = 'Verify Solution';
                verifyButton.onclick = () => verifySolution(index);
                
                codeBlock.appendChild(copyButton);
                codeBlock.appendChild(deleteButton);
                codeBlock.appendChild(editButton);
                codeBlock.appendChild(verifyButton);
                resultsContainer.appendChild(codeBlock);
            });
        }

        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            }, (err) => {
                console.error('Could not copy text: ', err);
                alert('Failed to copy text. Please try again.');
            });
        }

        function orderMCQs() {
            const orderedResults = allResults.flatMap(result => result.split('\n\n\n'))
                .filter(mcq => mcq.trim().match(/^\d+\./))
                .sort((a, b) => {
                    const numA = parseInt(a.match(/^(\d+)\./)[1]);
                    const numB = parseInt(b.match(/^(\d+)\./)[1]);
                    return numA - numB;
                });

            // Check for missing MCQs
            const numbers = orderedResults.map(mcq => parseInt(mcq.match(/^(\d+)\./)[1]));
            const maxNumber = Math.max(...numbers);
            for (let i = 1; i <= maxNumber; i++) {
                if (!numbers.includes(i)) {
                    console.warn(`MCQ number ${i} is missing`);
                }
            }

            allResults = [orderedResults.join('\n\n\n')];
            displayResults();
            saveToChat(allResults[0]);
        }

        function copyAllResults() {
            const allText = allResults.join('\n\n\n');
            copyToClipboard(allText, document.querySelector('.copy-button'));
        }

        function deleteResult(index) {
            allResults.splice(index, 1);
            displayResults();
            saveToChat(allResults.join('\n\n'));
        }

        function saveEdit(index, editableDiv) {
            allResults[index] = editableDiv.innerText;
            displayResults();
            saveToChat(allResults.join('\n\n'));
        }

        async function recheckSolutions() {
            const apiKey = document.getElementById('apiKey').value;
            const modelName = document.getElementById('modelSelect').value;

            if (!apiKey) {
                alert('Please enter API key.');
                return;
            }

            const reCheckedResults = [];
            for (let mcq of allResults.flatMap(result => result.split('\n\n\n'))) {
                try {
                    const recheckedMCQ = await callGeminiAPI(apiKey, modelName, mcq, 'text/plain', true);
                    reCheckedResults.push(recheckedMCQ);
                } catch (error) {
                    console.error(`Error rechecking MCQ:`, error);
                    reCheckedResults.push(`Error rechecking MCQ: ${error.message}`);
                }
                await new Promise(resolve => setTimeout(resolve, IMAGE_PROCESSING_DELAY));
            }

            allResults = [reCheckedResults.join('\n\n\n')];
            displayResults();
            saveToChat(allResults[0]);
        }

        async function verifySolution(index) {
            const apiKey = document.getElementById('apiKey').value;
            const modelName = document.getElementById('modelSelect').value;

            if (!apiKey) {
                alert('Please enter API key.');
                return;
            }

            const mcq = allResults[index];
            try {
                const verifiedMCQ = await callGeminiAPI(apiKey, modelName, mcq, 'text/plain', true);
                allResults[index] = verifiedMCQ;
                displayResults();
                saveToChat(allResults.join('\n\n'));
            } catch (error) {
                console.error(`Error verifying solution:`, error);
                alert(`Error verifying solution: ${error.message}`);
            }
        }

        function editPrompt() {
            const promptInput = document.getElementById('promptInput');
            const promptPreview = document.getElementById('promptPreview');
            promptPreview.textContent = promptInput.value;
            promptPreview.style.display = 'block';
            promptInput.style.display = 'none';
        }

        async function processPrompt() {
            const apiKey = document.getElementById('apiKey').value;
            const modelName = document.getElementById('modelSelect').value;
            const promptInput = document.getElementById('promptInput');
            const promptPreview = document.getElementById('promptPreview');
            const resultsContainer = document.getElementById('resultsContainer');

            if (!apiKey) {
                alert('Please enter API key.');
                return;
            }

            const userPrompt = promptPreview.style.display === 'block' ? promptPreview.textContent : promptInput.value;
            if (!userPrompt && promptImages.length === 0) {
                alert('Please enter a prompt or upload an image.');
                return;
            }

            try {
                const currentMCQs = allResults.length > 0 ? allResults.join('\n\n') : "No MCQs extracted yet.";
                let imageData = [];

                for (let file of promptImages) {
                    imageData.push({
                        inline_data: {
                            mime_type: file.type,
                            data: await getBase64(file)
                        }
                    });
                }

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: `Current MCQs:\n\n${currentMCQs}\n\nUser prompt: ${userPrompt}\n\nInstructions:
                1. Process the MCQs according to the user's prompt.
                2. Only modify the questions specified in the prompt.
                3. For each modified question, create a new entry without changing the original.
                4. Do not include phrases like "Therefore, the correct answer is...".
                5. Maintain the original formatting and structure of the MCQs.
                6. If no MCQs exist, generate new ones based on the prompt.
                7. Return only the new or modified MCQs, not the entire set.
                8. If images are provided, analyze them and incorporate relevant information into the MCQs.
                9. Provide complete calculations in solutions, formatted line by line for readability.
                10. Use '^' for exponents instead of HTML superscript tags. For example, write 'x^2' instead of 'x<sup>2</sup>'.
                11. If you detect a diagram or complex image in the question, add the fire emoji (ðŸ”¥) at the beginning of the question text.` },
                                ...imageData
                            ]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 8192,
                            stopSequences: []
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`API error: ${response.status} - ${JSON.stringify(errorData)}`);
                }

                const data = await response.json();
                const processedResult = data.candidates[0].content.parts[0].text.trim();
                allResults.push(processedResult);
                displayResults();
                promptInput.value = '';
                promptPreview.textContent = '';
                promptPreview.style.display = 'none';
                promptInput.style.display = 'block';
                clearPromptImages();
                saveToChat(processedResult);
            } catch (error) {
                console.error('Error processing prompt:', error);
                alert(`Error processing prompt: ${error.message}`);
            }
        }

        function clearPromptImages() {
            const promptImagesContainer = document.getElementById('promptImages');
            promptImagesContainer.innerHTML = '';
            promptImages = [];
            document.getElementById('promptImageInput').value = '';
        }

        function updateProgressBar(current, total) {
            const progressBar = document.getElementById('progressBarFill');
            const progressText = document.getElementById('progressText');
            const percentage = (current / total) * 100;
            progressBar.style.width = `${percentage}%`;
            progressText.textContent = `Processing: ${current} / ${total} images`;
        }

        function startTimer() {
            startTime = Date.now();
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        function updateTimer() {
            const elapsedTime = Math.floor((Date.now() - startTime) / 1000);
            const hours = Math.floor(elapsedTime / 3600);
            const minutes = Math.floor((elapsedTime % 3600) / 60);
            const seconds = elapsedTime % 60;
            document.getElementById('timerDisplay').textContent = 
                `Time elapsed: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function playAlarmSound() {
            const alarmSound = document.getElementById('alarmSound');
            alarmSound.play();
        }

        // Chat history functions
        function saveToChat(content) {
            if (!auth.currentUser) return;
            
            if (!currentChatId) {
                currentChatId = Date.now().toString();
            }

            db.collection('chats').doc(currentChatId).set({
                userId: auth.currentUser.uid,
                content: content,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true })
            .then(() => {
                console.log("Chat saved successfully");
                loadChatHistory();
            })
            .catch((error) => {
                console.error("Error saving chat: ", error);
            });
        }

        function loadChatHistory() {
            if (!auth.currentUser) return;

            db.collection('chats')
                .where('userId', '==', auth.currentUser.uid)
                .orderBy('timestamp', 'desc')
                .get()
                .then((querySnapshot) => {
                    const chatList = document.getElementById('chatList');
                    chatList.innerHTML = '';
                    querySnapshot.forEach((doc) => {
                        const chatData = doc.data();
                        const chatItem = document.createElement('div');
                        chatItem.className = 'chat-item';
                        chatItem.textContent = `Chat from ${chatData.timestamp.toDate().toLocaleString()}`;
                        chatItem.onclick = () => loadChat(doc.id);
                        chatList.appendChild(chatItem);
                    });
                })
                .catch((error) => {
                    console.error("Error loading chat history: ", error);
                });
        }

        function loadChat(chatId) {
            db.collection('chats').doc(chatId).get()
                .then((doc) => {
                    if (doc.exists) {
                        const chatData = doc.data();
                        allResults = [chatData.content];
                        displayResults();
                        currentChatId = chatId;
                    } else {
                        console.log("No such document!");
                    }
                })
                .catch((error) => {
                    console.error("Error loading chat: ", error);
                });
        }

        function newChat() {
            allResults = [];
            displayResults();
            currentChatId = null;
        }

        // Event listeners
        document.getElementById('themeToggle').addEventListener('click', function() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            let newTheme;
            switch (currentTheme) {
                case 'light':
                    newTheme = 'dark';
                    break;
                case 'dark':
                    newTheme = 'blue';
                    break;
                case 'blue':
                    newTheme = 'green';
                    break;
                default:
                    newTheme = 'light';
            }
            document.documentElement.setAttribute('data-theme', newTheme);
        });

        document.getElementById('sidebarToggle').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
            if (sidebar.classList.contains('open')) {
                document.querySelector('.container').style.marginLeft = '300px';
            } else {
                document.querySelector('.container').style.marginLeft = '0';
            }
        });

        document.getElementById('newChatBtn').addEventListener('click', newChat);

        document.addEventListener('dragover', (e) => {
            e.preventDefault();
        });

        document.addEventListener('drop', (e) => {
            e.preventDefault();
            handleFiles(e.dataTransfer.files);
        });

        document.addEventListener('paste', (e) => {
            const items = e.clipboardData.items;
            for (let item of items) {
                if (item.type.indexOf('image') !== -1) {
                    const blob = item.getAsFile();
                    handleFiles([blob]);
                }
            }
        });

        function handleFiles(files) {
            for (let file of files) {
                if (file.type === 'application/pdf') {
                    convertPDFToImages(file);
                } else if (file.type.startsWith('image/')) {
                    addImages([file]);
                }
            }
        }

        document.getElementById('pdfInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file && file.type === 'application/pdf') {
                convertPDFToImages(file);
            } else {
                alert('Please upload a PDF file.');
            }
        });

        document.getElementById('imageInput').addEventListener('change', function(e) {
            addImages(e.target.files);
        });

        const promptBox = document.getElementById('promptBox');
        const promptInput = document.getElementById('promptInput');

        promptBox.addEventListener('dragover', (e) => {
            e.preventDefault();
            promptBox.style.backgroundColor = 'rgba(0, 0, 0, 0.1)';
        });

        promptBox.addEventListener('dragleave', () => {
            promptBox.style.backgroundColor = '';
        });

        promptBox.addEventListener('drop', (e) => {
            e.preventDefault();
            promptBox.style.backgroundColor = '';
            handlePromptFiles(e.dataTransfer.files);
        });

        promptInput.addEventListener('paste', (e) => {
            const items = e.clipboardData.items;
            for (let item of items) {
                if (item.type.indexOf('image') !== -1) {
                    const blob = item.getAsFile();
                    handlePromptFiles([blob]);
                }
            }
        });

        function handlePromptFiles(files) {
            for (let file of files) {
                if (file.type.startsWith('image/')) {
                    addPromptImage(file);
                }
            }
        }

        function addPromptImage(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                document.getElementById('promptImages').appendChild(img);
                promptImages.push(file);
            }
            reader.readAsDataURL(file);
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Set initial theme
            const prefersDarkScheme = window.matchMedia("(prefers-color-scheme: dark)");
            if (prefersDarkScheme.matches) {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
            }

            // Check if user is already logged in
            auth.onAuthStateChanged((user) => {
                if (user) {
                    showUserInfo(user);
                } else {
                    showAuthForms();
                }
            });

            // Initialize any necessary components or state
        });
    </script>
</body>
</html>